---
title: "NaqviEtal17_figures.Rmd"
author: "Sahin Naqvi"
date: "3/22/2017"
output: html_document
---


Figure 1
```{r}
#matrix of Pct scores for all genes, available by combining Pct columns from Figure 1 Source Data 1, Figure 2 Source Data 1, and Figure 4 Source Data 1 
gene_mir_all_pcts = read.table("PATH",stringsAsFactors = FALSE,sep=",",fill = TRUE)

exac_dupscore_classifications = read.table("PATH_TO_FIGURE1_SOURCEDATA1",stringsAsFactors = FALSE,sep="\t")

exac_del_dup = subset(exac_scores,("ExAC.copy.number.status" == "Dup_Del"))$Gene
exac_del_nodup = subset(exac_scores,("ExAC.copy.number.status" == "NotDup_Del"))$Gene
exac_nodel_dup = subset(exac_scores,("ExAC.copy.number.status" == "Dup_NotDel"))$Gene
exac_nodel_nodup = subset(exac_scores,("ExAC.copy.number.status" == "NotDup_NotDel"))$Gene

par(mfrow=c(1,2),mar=c(4.1,4.1,2.1,2.1))

plot(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% exac_del_nodup),-1]))),col="steelblue1",ylim=c(0.4,1),ylab = "",xlab="",main="",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(0,1))
axis(1,lwd = 2 )
axis(2,lwd=2,las=1)
mtext(text = c("Cumulative fraction",expression('Gene-miRNA P'['CT'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% exac_del_dup),-1]))),col="grey",verticals = TRUE,do.points=FALSE,lwd=2)
legend(0.15,0.75, legend = c("Deleted, duplicated","Deleleted, not duplicated"), fill=c("grey", "steelblue1"),cex=1,border=NA,bty="n",y.intersp = 1)

plot(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% exac_nodel_nodup),-1]))),col="purple",ylim=c(0.4,1),ylab = "",xlab="",main="",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(0,1))
axis(1,lwd = 2 )
axis(2,lwd=2,las=1)
mtext(text = c("Cumulative fraction",expression('Gene-miRNA P'['CT'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% exac_nodel_dup),-1]))),col="orange",verticals = TRUE,do.points=FALSE,lwd=2)
legend(0.15,0.75, legend = c("Not deleted, duplicated","Not deleted, not duplicated"), fill=c("orange","purple"),cex=1,border=NA,bty="n",y.intersp = 1)


```

Figure 1 - Figure Supplement 1
```{r}
par(mfrow=c(1,2),mar=c(4.1,4.1,2.1,2.1))

plot(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% exac_nodel_dup),-1]))),col="orange",ylim=c(0.4,1),ylab = "",xlab="",main="",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(0,1))
axis(1,lwd = 2 )
axis(2,lwd=2,las=1)
mtext(text = c("Cumulative fraction",expression('Gene-miRNA P'['CT'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% exac_del_dup),-1]))),col="grey",verticals = TRUE,do.points=FALSE,lwd=2)
legend(0.15,0.75, legend = c("Not Deleted, duplicated","Deleleted, duplicated"), fill=c("orange", "grey"),cex=1,border=NA,bty="n",y.intersp = 1)

plot(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% exac_nodel_nodup),-1]))),col="purple",ylim=c(0.4,1),ylab = "",xlab="",main="",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(0,1))
axis(1,lwd = 2 )
axis(2,lwd=2,las=1)
mtext(text = c("Cumulative fraction",expression('Gene-miRNA P'['CT'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% exac_del_nodup),-1]))),col="steelblue1",verticals = TRUE,do.points=FALSE,lwd=2)
legend(0.15,0.75, legend = c("Deleted, not duplicated","Not deleted, not duplicated"), fill=c("purple","steelblue1"),cex=1,border=NA,bty="n",y.intersp = 1)
```


Figure 1 - Figure Supplement 2 - requires samplePcts.R and gplots
```{r}
require(gplots)
source('PATH_TO_samplePcts.R')
exac_dupscore_subsamp = samplePcts(gene_mir_all_pcts,exac_dupscore_classifications,1000,'mean_pct','quantile') 

plotCI(x = c(0.5,1.5,2.5,3.5),y=exac_dupscore_subsamp[,"Estimate"],ui = exac_dupscore_subsamp[,"Hi"],li=exac_dupscore_subsamp[,"Lo"],main="",xlim=c(0,4),pch=15,lwd=2.2,ylab=expression('Subsampled gene-miRNA P'['CT']),at=c(0.5,1.5,2.5,3.5),xlab="",col=c("grey","steelblue1","orange","purple"),axes=FALSE,ylim=c(0.08,0.14),cex=1.3,sfrac=0.025,gap = 0.5)
axis(side=1,at=c(0.5,1.5,2.5,3.5),labels=c("Del\ndup","Del\nnot dup","Not del\ndup","Not del\nnot dup"),lwd = 2)
axis(side=2,lwd=2,las=1)
```


Figure 2
```{r}
ancX_info = read.table("PATH_TO_FIGURE2_SOURCEDATA",header = TRUE,stringsAsFactors = FALSE,sep="\t")
igenes = subset(ancX_info,(Human.Y=="N")&(XCI=="I"))$Gene
evegenes = subset(ancX_info,(Human.Y=="N")&(XCI %in% c("E","VE")))$Gene
xygenes = subset(ancX_info,Human.Y=="Y")$Gene
xygenes_8mamm = subset(ancX_info,X8.mammals.Y=="Y")$Gene
ancx_8mamm = subset(ancX_info,X8.mammals.Y=="N")$Gene

par(mfrow=c(1,2),mar=c(4.1,4.1,2.1,1.1))
plot(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% xygenes),-1]))),col="steelblue1",ylim=c(0.4,1),ylab = "",xlab="",main="",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(0,1))
axis(1,lwd = 2 )
axis(2,lwd=2)
mtext(text = c("Cumulative fraction",expression('Gene-miRNA P'['CT'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% igenes),-1]))),col="lightgreen",verticals = TRUE,do.points=FALSE,lwd=2)
lines(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% evegenes),-1]))),col="orange",verticals = TRUE,do.points=FALSE,lwd=2)
legend(0.2,0.7, legend = c("X-Y pairs", "Inactivated","Escape"), fill=c("steelblue1", "lightgreen","orange"),cex=1,border=NA,bty="n")

plot(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% xygenes_8mamm),-1]))),col="steelblue1",ylim=c(0.4,1),ylab = "",xlab="",main="",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2)
axis(1,lwd = 2 )
axis(2,lwd=2)
mtext(text = c("Cumulative fraction",expression('Gene-miRNA P'['CT'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% ancx_8mamm),-1]))),col="grey",verticals = TRUE,do.points=FALSE,lwd=2)
legend(0.2,0.7, legend = c("X-Y pairs\n(8 mammals)", "Ancestral X"), fill=c("steelblue1", "grey"),cex=1,border=NA,bty="n",y.intersp = 1.2)

```

Figure 2 - Figure Supplement 1
```{r}
ancX_info_forsubsamp = ancX_info[,c("Gene","XCI")]
ancX_info_forsubsamp[which(ancX_info[,"XCI"]=="VE"),"XCI"] = "E"
ancX_info_forsubsamp[which(ancX_info[,"Human.Y"]=="Y"),"XCI"] = "XY pair"
ancx_subsamp_eve_comb = samplePcts(gene_mir_all_pcts,ancX_info_forsubsamp,1000,'mean_pct','quantile') 

plotCI(x = c(0.5,1.5,2.5),y=ancx_subsamp_eve_comb[c(3,1,2),"Estimate"],ui = ancx_subsamp_eve_comb[c(3,1,2),"Hi"],li=ancx_subsamp_eve_comb[c(3,1,2),"Lo"],main="",xlim=c(0,3),pch=15,lwd=2.2,ylab=expression('Subsampled gene-miRNA P'['CT']),at=c(0.5,1.5,2.5),xlab="",col=c("steelblue1","lightgreen","orange"),axes=FALSE,ylim=c(0.05,0.25),cex=1.3,sfrac=0.025,gap=0.5)
axis(side=1,at=c(0.5,1.5,2.5),labels=c("X-Y pairs","I","E"),lwd = 2)
axis(side=2,lwd=2)

ancX_info_forsubsamp = ancX_info[,c("Gene","X8.mammal.Y")]
ancx_subsamp_8mamm = samplePcts(gene_mir_all_pcts,ancX_info_forsubsamp,1000,'mean_pct','quantile') 
plotCI(x = c(0.5,1.5),y=ancx_subsamp_8mamm[c(2,1),"Estimate"],ui = ancx_subsamp_8mamm[c(2,1),"Hi"],li=ancx_subsamp_8mamm[c(2,1),"Lo"],main="",xlim=c(0,2),pch=15,lwd=2.2,ylab=expression('Subsampled gene-miRNA P'['CT']),at=c(0.5,1.5),xlab="",col=c("steelblue1","grey"),axes=FALSE,ylim=c(0.05,0.25),cex=1.3,sfrac=0.025,gap=0.5)
axis(side=1,at=c(0.5,1.5),labels=c("X-Y pairs\n(8 mammals)","Ancestral X"),lwd = 2)
axis(side=2,lwd=2)

```


Figure 2 - Figure Supplement 3
```{r}
egenes = subset(ancX_info,(Human.Y=="N")&(XCI %in% c("E")))$Gene
vegenes = subset(ancX_info,(Human.Y=="N")&(XCI %in% c("VE")))$Gene

par(mfrow=c(1,2))
plot(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% xygenes),-1]))),col="steelblue1",ylim=c(0.4,1),ylab = "",xlab="",main="",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2)
axis(1,lwd = 2 )
axis(2,lwd=2)
mtext(text = c("Cumulative fraction",expression('Gene-miRNA P'['CT'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% igenes),-1]))),col="lightgreen",verticals = TRUE,do.points=FALSE,lwd=2)
lines(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% egenes),-1]))),col="red",verticals = TRUE,do.points=FALSE,lwd=2)
lines(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% vegenes),-1]))),col="purple",verticals = TRUE,do.points=FALSE,lwd=2)
legend(0.2,0.7, legend = c("X-Y pairs", "Inactivated","Var. escape","Cons. Escape"), fill=c("steelblue1", "lightgreen","purple","red"),cex=1,border=NA,bty="n")

ancX_info_forsubsamp = ancX_info[,c("Gene","XCI")]
ancX_info_forsubsamp[which(ancX_info[,"Human.Y"]=="Y"),"XCI"] = "XY pair"
ancx_subsamp_eve_sep = samplePcts(gene_mir_all_pcts,ancX_info_forsubsamp,1000,'mean_pct','quantile') 
plotCI(x = c(0.5,1.5,2.5,3.5),y=ancx_subsamp_eve_sep[c(2,3,1,4),"Estimate"],ui = ancx_subsamp_eve_sep[c(2,3,1,4),"Hi"],li=ancx_subsamp_eve_sep[c(2,3,1,4),"Lo"],main="",xlim=c(0,4),pch=15,lwd=2.1,ylab=expression('Subsampled gene-miRNA P'['CT']),at=c(0.5,1.5,2.5,3.5),xlab="",col=c("red","purple","lightgreen","steelblue1"),axes=FALSE,ylim=c(0.05,0.25),cex=1.3,sfrac=0.025,gap=0.5)
axis(side=1,at=c(0.5,1.5,2.5,3.5),labels=c("CE","VE","I","XY pairs"),lwd = 2)
axis(side=2,lwd=2)
```

Figure 3
```{r}
esc_counts = table(na.omit(subset(ancX_info,(Human.Y=="N")&(XCI %in% c("E","VE")))[,5]) > 0)
inact_counts = table(na.omit(subset(ancX_info,(Human.Y=="N")&(XCI %in% c("I")))[,5]) > 0)
xy_human_counts = table(subset(ancX_info,Human.Y=="Y")[,5] > 0)
xy_all_counts = table(na.omit(subset(ancX_info,X8.mammals.Y=="Y")[,5]) > 0)
other_x_all_counts = table(na.omit(subset(ancX_info,X8.mammals.Y=="Y")[,5]) > 0)


par(mfrow=c(1,2),mar=c(4.1,4.1,2.1,0.1))

barplot(cbind(c(xy_human_counts[2])/(sum(xy_human_counts)),c(inact_counts[2])/(sum(inact_counts)),c(esc_counts[2])/(sum(esc_counts))), col='white', axes=F,ylab = "Fraction of genes with ancestral site",names.arg = c("X-Y pairs","I","E"),width = 0.8,ylim=c(0,0.7))
barplot(cbind(c(xy_human_counts[2])/(sum(xy_human_counts)),c(inact_counts[2])/(sum(inact_counts)),c(esc_counts[2])/(sum(esc_counts))), col='orange', axes=F,add=T,width = 0.8)
barplot(cbind(c(xy_human_counts[2])/(sum(xy_human_counts)),c(inact_counts[2])/(sum(inact_counts))), col='lightgreen', axes=F,add=T,width = 0.8)
barplot(cbind(c(xy_human_counts[2])/(sum(xy_human_counts))),ylab="",args.legend = "bottomright",col=c("steelblue1"),add = TRUE,axes = FALSE,width = 0.8)
axis(2,lwd=2,las=1)

barplot(cbind(c(xy_all_counts[2])/(sum(xy_all_counts)),c(other_x_all_counts[2])/(sum(other_x_all_counts))), col='white', axes=F,ylab = "Fraction of genes with ancestral site",names.arg = c("X-Y pairs\n(8 mammals)","Ancestral X"),xlim=c(0,3),ylim=c(0,0.7))
barplot(cbind(c(xy_all_counts[2])/(sum(xy_all_counts)),c(other_x_all_counts[2])/(sum(other_x_all_counts))), col='grey', axes=F,add=T)
barplot(cbind(c(xy_all_counts[2])/(sum(xy_all_counts))), col='steelblue1', axes=F,add=T)
axis(2,lwd=2,las=1)

```


Figure 3 - Figure Supplement 1
```{r}
esc_counts = table(na.omit(subset(ancX_info,(Human.Y=="N")&(XCI %in% c("E","VE")))[,7]))
inact_counts = table(na.omit(subset(ancX_info,(Human.Y=="N")&(XCI %in% c("I")))[,7]))
xy_human_counts = table(subset(ancX_info,Human.Y=="Y")[,7])
xy_all_counts = table(na.omit(subset(ancX_info,X8.mammals.Y=="Y")[,7]))
other_x_all_counts = table(na.omit(subset(ancX_info,X8.mammals.Y=="Y")[,7]))

par(mfrow=c(1,2),mar=c(4.1,4.1,2.1,0.1))
barplot(cbind(c(xy_human_counts[2])/(sum(xy_human_counts)),c(inact_counts[2])/(sum(inact_counts)),c(esc_counts[2])/(sum(esc_counts))), col='white', axes=F,ylab = "Fraction with conservation > background",names.arg = c("X-Y pairs","I","E"),ylim=c(0,0.6))
barplot(cbind(c(xy_human_counts[2])/(sum(xy_human_counts)),c(inact_counts[2])/(sum(inact_counts)),c(esc_counts[2])/(sum(esc_counts))), col='orange', axes=F,add=T)
barplot(cbind(c(xy_human_counts[2])/(sum(xy_human_counts)),c(inact_counts[2])/(sum(inact_counts))), col='lightgreen', axes=F,add=T)
barplot(cbind(c(xy_human_counts[2])/(sum(xy_human_counts))),ylab="",args.legend = "bottomright",col=c("steelblue1"),add = TRUE,axes = FALSE)
axis(2,lwd=2,las=1)

barplot(cbind(c(xy_all_counts[2])/(sum(xy_all_counts)),c(other_x_all_counts[2])/(sum(other_x_all_counts))), col='white', axes=F,ylab = "Fraction with conservation > background",names.arg = c("X-Y pairs\n(8 mammals)","Ancestral X"),xlim=c(0,3),ylim=c(0,0.6))
barplot(cbind(c(xy_all_counts[2])/(sum(xy_all_counts)),c(other_x_all_counts[2])/(sum(other_x_all_counts))), col='grey', axes=F,add=T)
barplot(cbind(c(xy_all_counts[2])/(sum(xy_all_counts))), col='steelblue1', axes=F,add=T)
axis(2,lwd=2,las=1)

```

Figure 4
```{r}
ancZ_info = read.table("PATH_TO_FIGURE4_SOURCEDATA",header = TRUE,stringsAsFactors = FALSE,sep="\t")

par(mfrow=c(1,3),mar=c(4.1,3.6,2.1,0.5),cex=1)
plot(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% subset(ancZ_info,chicken.W=="Y")$Gene),-1]))),col="steelblue1",ylim=c(0.4,1),ylab = "",xlab="",main="",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(0,1))
axis(1,lwd = 2 )
axis(2,lwd=2)
mtext(text = c("Cumulative fraction",expression('Gene-miRNA P'['CT'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% subset(ancZ_info,chicken.W=="N")$Gene),-1]))),col="grey",verticals = TRUE,do.points=FALSE,lwd=2)
legend(0.1,0.65, legend = c("Z-W pairs\n(Chicken)", "Ancestral Z"), fill=c("steelblue1", "grey"),cex=1,border=NA,bty="n")

plot(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% subset(ancZ_info,X4.birds.W=="Y")$Gene),-1]))),col="steelblue1",ylim=c(0.4,1),ylab = "",xlab="",main="",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(0,1))
axis(1,lwd = 2 )
axis(2,lwd=2)
mtext(text = c("Cumulative fraction",expression('Gene-miRNA P'['CT'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% subset(ancZ_info,X4.birds.W=="N")$Gene),-1]))),col="grey",verticals = TRUE,do.points=FALSE,lwd=2)
legend(0.1,0.65, legend = c("Z-W pairs\n(4 birds)", "Ancestral Z"), fill=c("steelblue1", "grey"),cex=1,border=NA,bty="n",y.intersp = 1)

plot(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% subset(ancZ_info,X14.birds.W=="Y")$Gene),-1]))),col="steelblue1",ylim=c(0.4,1),ylab = "",xlab="",main="",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(0,1))
axis(1,lwd = 2 )
axis(2,lwd=2)
mtext(text = c("Cumulative fraction",expression('Gene-miRNA P'['CT'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(as.matrix(gene_mir_all_pcts[which(gene_mir_all_pcts[,1] %in% subset(ancZ_info,X14.birds.W=="Y")$Gene),-1]))),col="grey",verticals = TRUE,do.points=FALSE,lwd=2)
legend(0.1,0.65, legend = c("Z-W pairs\n(14 birds)", "Ancestral Z"), fill=c("steelblue1", "grey"),cex=1,border=NA,bty="n",y.intersp = 1)


```

Figure 4  - Figure Supplement 1
```{r}
subsamp_pct_comps_highzw = samplePcts(gene_mir_all_pcts,ancZ_info[,c("Gene","chicken.W")])
subsamp_pct_comps_intzw = samplePcts(gene_mir_all_pcts,ancZ_info[,c("Gene","X4.birds.W")])
subsamp_pct_comps_lowzw = samplePcts(gene_mir_all_pcts,ancZ_info[,c("Gene","X14.birds.W")])
  
par(mfrow=c(1,3),mar=c(4.1,4.1,2.1,1.1),cex=1)
plotCI(x = c(0.5,1.5),y=subsamp_pct_comps_highzw[c(2,1),"Estimate"],ui = subsamp_pct_comps_highzw[c(2,1),"Hi"],li=subsamp_pct_comps_highzw[c(2,1),"Lo"],main="",xlim=c(0,2),pch=15,lwd=2.2,ylab=expression('Subsampled gene-miRNA P'['CT']),at=c(0.5,1.5),xlab="",col=c("steelblue1","grey"),axes=FALSE,ylim=c(0.1,0.25),cex=1.3,sfrac=0.025,gap=0.5)
axis(side=1,at=c(0.5,1.5),labels=c("Z-W pairs","Ancestral Z"),lwd = 2)
axis(side=2,lwd=2)

plotCI(x = c(0.5,1.5),y=subsamp_pct_comps_intzw[c(2,1),"Estimate"],ui = subsamp_pct_comps_intzw[c(2,1),"Hi"],li=subsamp_pct_comps_intzw[c(2,1),"Lo"],main="",xlim=c(0,2),pch=15,lwd=2.2,ylab=expression('Subsampled gene-miRNA P'['CT']),at=c(0.5,1.5),xlab="",col=c("steelblue1","grey"),axes=FALSE,ylim=c(0.1,0.25),cex=1.3,sfrac=0.025,gap=0.5)
axis(side=1,at=c(0.5,1.5),labels=c("Z-W pairs\n(4 birds)","Ancestral Z"),lwd = 2)
axis(side=2,lwd=2)

plotCI(x = c(0.5,1.5),y=subsamp_pct_comps_lowzw[c(2,1),"Estimate"],ui = subsamp_pct_comps_lowzw[c(2,1),"Hi"],li=subsamp_pct_comps_lowzw[c(2,1),"Lo"],main="",xlim=c(0,2),pch=15,lwd=2.2,ylab=expression('Subsampled gene-miRNA P'['CT']),at=c(0.5,1.5),xlab="",col=c("steelblue1","grey"),axes=FALSE,ylim=c(0.1,0.25),cex=1.3,sfrac=0.025,gap=0.5)
axis(side=1,at=c(0.5,1.5),labels=c("Z-W pairs\n(14 birds)","Ancestral Z"),lwd = 2)
axis(side=2,lwd=2)

```


Figure 5
```{r}
ancZ_info_chickencons = read.table("PATH_TO_FIGURE5_SOURCEDATA",header = TRUE,stringsAsFactors = FALSE,sep="\t")
ancZ_info_chickencons = merge(ancZ_info,ancZ_info_chickencons,by=1)

zw_chicken_counts = table(subset(ancZ_info_chickencons,(chicken.W =="Y"))[,7] > 0)
other_z_counts = table(subset(ancZ_info_chickencons,(chicken.W =="N"))[,7] > 0)
zw_4spec_counts = table(subset(ancZ_info_chickencons,(X4.birds.W =="Y"))[,7] > 0)
other_z_4spec_counts = table(subset(ancZ_info_chickencons,(X4.birds.W =="N"))[,7] > 0)
zw_14spec_counts = table(subset(ancZ_info_chickencons,(X14.birds.W =="Y"))[,7] > 0)
other_z_14spec_counts = table(subset(ancZ_info_chickencons,(X14.birds.W =="N"))[,7] > 0)


par(mfrow=c(1,3),mar=c(4.1,1.1,2.1,0.0),cex=1)
barplot(cbind(c(zw_chicken_counts[2])/(sum(zw_chicken_counts)),c(other_z_counts[2])/(sum(other_z_counts))), col='white', axes=F,ylab = "Fraction of genes with ancestral site",names.arg = c("Z-W pairs\n(Chicken)","Anc. Z"),ylim=c(0,0.8),xlim=c(0,3))
barplot(cbind(c(zw_chicken_counts[2])/(sum(zw_chicken_counts)),c(other_z_counts[2])/(sum(other_z_counts))), col='grey', axes=F,add=T)
barplot(cbind(c(zw_chicken_counts[2])/(sum(zw_chicken_counts))), col='steelblue1', axes=F,add=T)
axis(2,lwd=2,las=1)

barplot(cbind(c(zw_4spec_counts[2])/(sum(zw_4spec_counts)),c(other_z_4spec_counts[2])/(sum(other_z_4spec_counts))), col='white', axes=F,ylab = "Fraction of genes with ancestral site",names.arg = c("Z-W pairs\n(4 birds)","Anc. Z"),xlim=c(0,3),ylim=c(0,0.8))
barplot(cbind(c(zw_4spec_counts[2])/(sum(zw_4spec_counts)),c(other_z_4spec_counts[2])/(sum(other_z_4spec_counts))), col='grey', axes=F,add=T)
barplot(cbind(c(zw_4spec_counts[2])/(sum(zw_4spec_counts))), col='steelblue1', axes=F,add=T)
axis(2,lwd=2,las=1)

barplot(cbind(c(zw_14spec_counts[2])/(sum(zw_14spec_counts)),c(other_z_14spec_counts[2])/(sum(other_z_14spec_counts))), col='white', axes=F,ylab = "Fraction of genes with ancestral site",names.arg = c("Z-W pairs\n(14 birds)","Anc. Z"),xlim=c(0,3),ylim=c(0,0.8))
barplot(cbind(c(zw_14spec_counts[2])/(sum(zw_14spec_counts)),c(other_z_14spec_counts[2])/(sum(other_z_14spec_counts))), col='grey', axes=F,add=T)
barplot(cbind(c(zw_14spec_counts[2])/(sum(zw_14spec_counts))), col='steelblue1', axes=F,add=T)
axis(2,lwd=2,las=1)

```

Figure 5 - Figure Supplement 1
```{r}
zw_chicken_counts = table(subset(ancZ_info_chickencons,(chicken.W =="Y"))[,9])
other_z_counts = table(subset(ancZ_info_chickencons,(chicken.W =="N"))[,9])
zw_4spec_counts = table(subset(ancZ_info_chickencons,(X4.birds.W =="Y"))[,9])
other_z_4spec_counts = table(subset(ancZ_info_chickencons,(X4.birds.W =="N"))[,9])
zw_14spec_counts = table(subset(ancZ_info_chickencons,(X14.birds.W =="Y"))[,9])
other_z_14spec_counts = table(subset(ancZ_info_chickencons,(X14.birds.W =="N"))[,9])

par(mfrow=c(1,3),mar=c(4.1,1.1,2.1,0.0),cex=1)
barplot(cbind(c(zw_counts[2])/(sum(zw_counts)),c(other_z_counts[2])/(sum(other_z_counts))), col='white', axes=F,ylab = "Fraction genes with conservation > background",names.arg = c("Z-W pairs","Ancestral Z"),xlim=c(0,3),ylim=c(0,0.7))
barplot(cbind(c(zw_counts[2])/(sum(zw_counts)),c(other_z_counts[2])/(sum(other_z_counts))), col='grey', axes=F,add=T)
barplot(cbind(c(zw_counts[2])/(sum(zw_counts))), col='steelblue1', axes=F,add=T)
axis(2,lwd=2,las=1)


barplot(cbind(c(zw_4spec_counts[2])/(sum(zw_4spec_counts)),c(other_z_4spec_counts[2])/(sum(other_z_4spec_counts))), col='white', axes=F,ylab = "",names.arg = c("Z-W pairs\n(4 birds)","Ancestral Z"),xlim=c(0,3),ylim=c(0,0.7))
barplot(cbind(c(zw_4spec_counts[2])/(sum(zw_4spec_counts)),c(other_z_4spec_counts[2])/(sum(other_z_4spec_counts))), col='grey', axes=F,add=T)
barplot(cbind(c(zw_4spec_counts[2])/(sum(zw_4spec_counts))), col='steelblue1', axes=F,add=T)
axis(2,lwd=2,las=1)

barplot(cbind(c(zw_14spec_counts[2])/(sum(zw_14spec_counts)),c(other_z_14spec_counts[2])/(sum(other_z_14spec_counts))), col='white', axes=F,ylab = "",names.arg = c("Z-W pairs\n(14 birds)","Ancestral Z"),xlim=c(0,3),ylim=c(0,0.7))
barplot(cbind(c(zw_14spec_counts[2])/(sum(zw_14spec_counts)),c(other_z_14spec_counts[2])/(sum(other_z_14spec_counts))), col='grey', axes=F,add=T)
barplot(cbind(c(zw_14spec_counts[2])/(sum(zw_14spec_counts))), col='steelblue1', axes=F,add=T)
axis(2,lwd=2,las=1)

```

Figure 6 - Figure Supplement 1
```{r}
pct0_intmat = read.delim("PATH_TO_CONSERVEDINTS_FIGURE6_SOURCEDATA",header = TRUE,stringsAsFactors = FALSE,row.names = 1)
noncons_site_countmat = read.delim("PATH_TO_NONCONSERVEDINTS_FIGURE6_SOURCEDATA",header = TRUE,stringsAsFactors = FALSE,row.names = 1)
transfec74 = read.delim("PATH_TO_FIGURE6_SOURCEDATA_SUPP1",header = TRUE,stringsAsFactors = FALSE,row.names = 1)
arrayid_seed_famname = read.table("PATH_TO_FIGURE6_SOURCEDATA_SUPP1_SMALLTABLE",header = TRUE,stringsAsFactors = FALSE)
arrayid_seed_famname$Array_ID = make.names(arrayid2seed$Array_ID)
arrayid_seed_famname$Family = make.names(arrayid2seed$Family)

ancxz_comb = c(ancX_info$Gene,ancZ_info$Gene) # combine ancestral x and human orthologs of z genes for analysis

consint_vsnot_p = vector(length=nrow(arrayid_seed_famname))
names(consint_vsnot_p) = arrayid_seed_famname$tscan_famname
letters = c("A","B","C","D","E","F","G","H","I","J","K","L")
count = 0
par(mfrow=c(4,3),xpd=FALSE,mar=c(5.1,4.1,3.1,2.1))
for (fam in arrayid_seed_famname$tscan_famname){
  count = count + 1
  array_id = subset(arrayid_seed_famname,tscan_famname==fam)$Array_ID
  
  xz_consint =  rownames(pct0_intmat[which((rownames(pct0_intmat) %in% ancxz_comb)&(pct0_intmat[,fam]==1)),])
  nocons_noncons_int = rownames(pct0_intmat[which((pct0_intmat[,fam]==0)&(noncons_site_countmat[,fam]==0)),])
  
  consint_vsnot_p[fam] = ks.test(transfec74[intersect(rownames(transfec74),nocons_noncons_int),array_id],transfec74[intersect(rownames(transfec74),xz_consint),array_id])$p.value
  nwint = sum(!is.na(transfec74[intersect(rownames(transfec74),xz_consint),array_id]))
  nwoint = sum(!is.na(transfec74[intersect(rownames(transfec74),nocons_noncons_int),array_id]))
  
  mainstr = paste(strsplit(gsub("miR.","miR-",gsub('.3p','',gsub('.5p','',fam))),split="[.]")[[1]][1],"",sep="")
  star = "n.s."
  if (consint_vsnot_p[fam] < 0.05){star = " *"}
  if (consint_vsnot_p[fam] < 0.01){star = " **"}
  if (consint_vsnot_p[fam] < 0.001){star = " ***"}

  plot(ecdf(transfec74[intersect(rownames(transfec74),nocons_noncons_int),array_id]),col="black",ylim=c(0,1),ylab = "",xlab="",main=mainstr,verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(-0.5,0.5))
  text(c(0.25,0.25),c(0.4,0.15), labels = c(paste("X/Z (",as.character(nwint),")\nwith site",sep=""), paste("All (",as.character(nwoint),")\nno site",sep="")), fill=c("steelblue1", "grey"),col = c("red","black"),cex = 1.2)
  lines(x=c(0.45,0.45),y=c(0.4,0.15),lty=1,col="black")
  text(x=0.5,y=0.27,labels = star,srt=270,cex=1.3)

  axis(1,lwd = 2 )
  axis(2,lwd=2,las=1)
  mtext(text = c("Cumulative fraction",expression('mRNA fold change, log'['2'])),side = c(2,1),line = c(3,3),cex=1)
  lines(ecdf(transfec74[intersect(rownames(transfec74),xz_consint),array_id]),col="red",verticals = TRUE,do.points=FALSE,lwd=2)
  text(x=-0.8,y=1.15,labels = letters[count],xpd=NA,cex=1.8)
  
}

```

Figure 6 - Figure Supplement 2
```{r}
fourmir_transfec_kd = read.table("PATH_TO_FIGURE6_SOURCEDATA_SUPP2",header = TRUE,stringsAsFactors = FALSE)

par(mfrow=c(2,2),mar=c(5.1,4.1,3.1,2.1),cex = 1)
plot(ecdf(c(subset(fourmir_transfec_kd,Gene %in% rownames(pct0_intmat[which((pct0_intmat[,"miR.103.3p.107"]==0)&(noncons_site_countmat[,"miR.103.3p.107"]==0)),]))$mir103.transfec.HCT116)),col="black",ylim=c(0,1),ylab = "",xlab="",main="miR-103 transfection, HCT116 cells",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(-1,1))
axis(1,lwd = 2 )
axis(2,lwd=2,las=1)
mtext(text = c("Cumulative fraction",expression('mRNA fold change, log'['2'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(subset(fourmir_transfec_kd,Gene_symbol %in% rownames(pct0_intmat[which((rownames(pct0_intmat) %in% ancxz_comb)&(pct0_intmat[,"miR.103.3p.107"]==1)),]))$miR.103_tx_log2FC)),col="red",verticals = TRUE,do.points=FALSE,lwd=2)
text(c(0.5,0.5),c(0.35,0.15), labels = c("X/Z (140)\nwith site", "All (4411)\nno site"), fill=c("steelblue1", "grey"),col = c("red","black"),cex = 0.8)
text(x=-1.6,y=1.25,labels = "A",xpd=NA,cex=1.5)

plot(ecdf(c(subset(fourmir_transfec_kd,gene_name %in% rownames(pct0_intmat[which((pct0_intmat[,"miR.7.5p"]==0)&(noncons_site_countmat[,"miR.7.5p"]==0)),]))$mir7.transfec.HCT116)),col="black",ylim=c(0,1),ylab = "",xlab="",main="miR-7 transfection, HCT116 cells",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(-0.5,0.5))
axis(1,lwd = 2 )
axis(2,lwd=2,las=1)
mtext(text = c("Cumulative fraction",expression('mRNA fold change, log'['2'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(subset(fourmir_transfec_kd,gene_name %in% rownames(pct0_intmat[which((rownames(pct0_intmat) %in% ancxz_comb)&(pct0_intmat[,"miR.7.5p"]==1)),]))$mir7.transfec.HCT116)),col="red",verticals = TRUE,do.points=FALSE,lwd=2)
text(c(0.25,0.25),c(0.35,0.15), labels = c("X/Z (193)\nwith site", "All (4427)\nno site"), fill=c("steelblue1", "grey"),col = c("red","black"),cex = 0.8)
text(x=-0.8,y=1.25,labels = "B",xpd=NA,cex=1.5)

plot(ecdf(c(subset(fourmir_transfec_kd,gene_name %in% rownames(pct0_intmat[which((pct0_intmat[,"miR.25.3p.32.5p.92.3p.363.3p.367.3p"]==0)&(noncons_site_countmat[,"miR.25.3p.32.5p.92.3p.363.3p.367.3p"]==0)),]))$mir92a.knockdown.HEK293)),col="black",ylim=c(0,1),ylab = "",xlab="",main="miR-92a knockdown, HEK293 cells",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(-0.5,0.5))
axis(1,lwd = 2 )
axis(2,lwd=2,las=1)
mtext(text = c("Cumulative fraction",expression('mRNA fold change, log'['2'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(subset(fourmir_transfec_kd,gene_name %in% rownames(pct0_intmat[which((rownames(pct0_intmat) %in% ancxz_comb)&(pct0_intmat[,"miR.25.3p.32.5p.92.3p.363.3p.367.3p"]==1)),]))$mir92a.knockdown.HEK293)),col="red",verticals = TRUE,do.points=FALSE,lwd=2)
text(c(0.25,0.25),c(0.35,0.15), labels = c("X/Z (282)\nwith site", "All (9815)\nno site"), fill=c("steelblue1", "grey"),col = c("red","black"),cex = 0.8)
text(x=-0.8,y=1.25,labels = "C",xpd=NA,cex=1.5)

plot(ecdf(c(subset(fourmir_transfec_kd,gene_name %in% rownames(pct0_intmat[which((pct0_intmat[,"miR.124.3p"]==0)&(noncons_site_countmat[,"miR.124.3p"]==0)),]))$mir124.transfec.HEK293)),col="black",ylim=c(0,1),ylab = "",xlab="",main="miR-124 transfection, HEK293 cells",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(-1,1))
axis(1,lwd = 2 )
axis(2,lwd=2,las=1)
mtext(text = c("Cumulative fraction",expression('mRNA fold change, log'['2'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(subset(fourmir_transfec_kd,gene_name %in% rownames(pct0_intmat[which((rownames(pct0_intmat) %in% ancxz_comb)&(pct0_intmat[,"miR.124.3p"]==1)),]))$mir124.transfec.HEK293)),col="red",verticals = TRUE,do.points=FALSE,lwd=2)
text(c(0.25,0.25),c(0.35,0.15), labels = c("X/Z (290)\nwith site", "All (5515)\nno site"), fill=c("steelblue1", "grey"),col = c("red","black"),cex = 0.8)
text(x=-1.6,y=1.25,labels = "D",xpd=NA,cex=1.5)
```

Figure 6 - Figure Supplement 3
```{r}
mir155_mouse_fcs = read.table("PATH_TO_FIGURE6_SOURCEDATA_SUPP3",header = TRUE,stringsAsFactors = FALSE)

par(mfrow=c(2,2),mar=c(5.1,4.1,3.1,2.1),cex = 1)
plot(ecdf(c(subset(mir155_mouse_fcs,(Any.mouse.site == 0))$B.cell.RPF.log2FC)),col="black",ylim=c(0,1),ylab = "",xlab="",main="miR-155 KO, mouse B cells",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(-1,1))
axis(1,lwd = 2 )
axis(2,lwd=2,las=1)
mtext(text = c("Cumulative fraction",expression('RPF fold change, log'['2'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(subset(mir155_mouse_fcs,(Human.one.to.one.ortholog %in% ancxz_comb)&(Human.mouse.cons.site ==1))$B.cell.RPF.log2FC)),col="red",verticals = TRUE,do.points=FALSE,lwd=2)
par(lheight=.75)
text(c(0.6,0.6),c(0.35,0.15), labels = c("X/Z (39)\nhsa-mmu site", "All (3113)\nno site"),col = c("red","black"),cex = 0.8)
text(x=-1.65,y=1.2,labels = "A",xpd=NA,cex=1.5)

plot(ecdf(c(subset(mir155_mouse_fcs,(Any.mouse.site == 0))$T.cell.array.log2FC)),col="black",ylim=c(0,1),ylab = "",xlab="",main="miR-155 KO, mouse T cells",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(-1,1))
axis(1,lwd = 2 )
axis(2,lwd=2,las=1)
mtext(text = c("Cumulative fraction",expression('mRNA fold change, log'['2'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(subset(mir155_mouse_fcs,(Human.one.to.one.ortholog %in% ancxz_comb)&(Human.mouse.cons.site ==1))$T.cell.array.log2FC)),col="red",verticals = TRUE,do.points=FALSE,lwd=2)
text(c(0.6,0.6),c(0.35,0.15), labels = c("X/Z (34)\nhsa-mmu site", "All (4048)\nno site"),col = c("red","black"),cex = 0.8)
text(x=-1.65,y=1.2,labels = "B",xpd=NA,cex=1.5)

plot(ecdf(c(subset(mir155_mouse_fcs,(Any.mouse.site == 0))$Th1.cell.array.log2FC)),col="black",ylim=c(0,1),ylab = "",xlab="",main="miR-155 KO, mouse Th1 cells",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(-1,1))
axis(1,lwd = 2 )
axis(2,lwd=2,las=1)
mtext(text = c("Cumulative fraction",expression('mRNA fold change, log'['2'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(subset(mir155_mouse_fcs,(Human.one.to.one.ortholog %in% ancxz_comb)&(Human.mouse.cons.site ==1))$Th1.cell.array.log2FC)),col="red",verticals = TRUE,do.points=FALSE,lwd=2)
text(c(0.6,0.6),c(0.35,0.15), labels = c("X/Z (25)\nhsa-mmu site", "All (3231)\nno site"),col = c("red","black"),cex = 0.8)
text(x=-1.65,y=1.2,labels = "C",xpd=NA,cex=1.5)

plot(ecdf(c(subset(mir155_mouse_fcs,(Any.mouse.site == 0))$Th2.cell.array.log2FC)),col="black",ylim=c(0,1),ylab = "",xlab="",main="miR-155 KO, mouse Th2 cells",verticals = TRUE,do.points=FALSE,cex.main=0.95,axes=FALSE,lwd=2,xlim=c(-1,1))
axis(1,lwd = 2 )
axis(2,lwd=2,las=1)
mtext(text = c("Cumulative fraction",expression('mRNA fold change, log'['2'])),side = c(2,1),line = c(3,3),cex=1)
lines(ecdf(c(subset(mir155_mouse_fcs,(Human.one.to.one.ortholog %in% ancxz_comb)&(Human.mouse.cons.site ==1))$Th2.cell.array.log2FC)),col="red",verticals = TRUE,do.points=FALSE,lwd=2)
text(c(0.6,0.6),c(0.35,0.15), labels = c("X/Z (25)\nhsa-mmu site", "All (3223)\nno site"),col = c("red","black"),cex = 0.8)
text(x=-1.65,y=1.2,labels = "D",xpd=NA,cex=1.5)
```


Figure 6 - Figure Supplement 4
```{r}
mir124_7_clip = read.table("PATH_TO_FIGURE6_SOURCEDATA_SUPP4",header = TRUE,stringsAsFactors = FALSE)

mir124_nxzclip = length(intersect(subset(mir124_7_clip,mir124.transfec.CLIP==TRUE)$Gene.symbol,rownames(pct0_intmat[which((rownames(pct0_intmat) %in% ancxz_comb)&(pct0_intmat[,"miR.124.3p"]==1)),])))
mir124_nxztot = length(intersect(mir124_7_clip$Gene.symbol,rownames(pct0_intmat[which((rownames(pct0_intmat) %in% ancxz_comb)&(pct0_intmat[,"miR.124.3p"]==1)),])))
mir124_nallclip = length(intersect(subset(mir124_7_clip,mir124.transfec.CLIP==TRUE)$Gene.symbol,rownames(pct0_intmat[which((pct0_intmat[,"miR.124.3p"]==0)&(noncons_site_countmat[,"miR.124.3p"]==0)),])))
mir124_nalltot = length(intersect(mir124_7_clip$Gene.symbol,rownames(pct0_intmat[which((pct0_intmat[,"miR.124.3p"]==0)&(noncons_site_countmat[,"miR.124.3p"]==0)),])))

mir7_nxzclip = length(intersect(unique(mir7_clip$gene_symbol),rownames(pct0_intmat_hek293expr[which((rownames(pct0_intmat_hek293expr) %in% ancxz_comb)&(pct0_intmat_hek293expr[,"miR.7.5p"]==1)),])))
mir7_nxztot = length(rownames(pct0_intmat_hek293expr[which((rownames(pct0_intmat_hek293expr) %in% ancxz_comb)&(pct0_intmat_hek293expr[,"miR.7.5p"]==1)),]))
mir7_nallclip = length(intersect(unique(mir7_clip$gene_symbol),rownames(pct0_intmat_hek293expr[which((pct0_intmat_hek293expr[,"miR.7.5p"]==0)&(noncons_site_countmat_hek293expr[,"miR.7.5p"]==0)),])))
mir7_nalltot = length(rownames(pct0_intmat_hek293expr[which((pct0_intmat_hek293expr[,"miR.7.5p"]==0)&(noncons_site_countmat_hek293expr[,"miR.7.5p"]==0)),]))

par(mfrow=c(1,2),mar=c(3.1,4.1,5.1,2.1))
barplot(c(mir124_nxzclip/mir124_nxztot,mir124_nallclip/mir124_nalltot),names.arg = c("X/Z\ncons. site\n(290)","All\nno site\n(4393)"),main="post-miR-124 transfection",las=1,ylab="Fraction with observed AGO-PAR-CLIP cluster",col = c("red","black"))

barplot(c(mir7_nxzclip/mir7_nxztot,mir7_nallclip/mir7_nalltot),names.arg = c("X/Z\ncons. site\n(255)","All\nno site\n(5081)"),main="post-miR-7 transfection",las=1,ylab="Fraction with observed AGO-PAR-CLIP cluster",col = c("red","black"))

```

